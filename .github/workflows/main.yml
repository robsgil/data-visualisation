name: Validate Secrets

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly check on Sundays

jobs:
  check-secrets:
    name: Validate Repository Secrets
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check Required Secrets
      id: check_required
      run: |
        echo "üîê Checking repository secrets configuration..."
        echo ""
        
        MISSING_SECRETS=""
        ALL_GOOD=true
        
        # Check CLAUDE_API_KEY
        if [ -n "${{ secrets.CLAUDE_API_KEY }}" ]; then
          echo "‚úÖ CLAUDE_API_KEY is configured"
          # Validate format (should start with sk-ant-)
          KEY_PREFIX=$(echo "${{ secrets.CLAUDE_API_KEY }}" | cut -c1-7)
          if [ "$KEY_PREFIX" = "sk-ant-" ]; then
            echo "   ‚úì Key format appears valid"
          else
            echo "   ‚ö†Ô∏è Key format may be incorrect (should start with sk-ant-)"
          fi
        else
          echo "‚ùå CLAUDE_API_KEY is NOT configured"
          MISSING_SECRETS="CLAUDE_API_KEY"
          ALL_GOOD=false
        fi
        
        echo ""
        
        # Check RAILWAY_TOKEN
        if [ -n "${{ secrets.RAILWAY_TOKEN }}" ]; then
          echo "‚úÖ RAILWAY_TOKEN is configured"
        else
          echo "‚ö†Ô∏è RAILWAY_TOKEN is NOT configured (required for production deployment)"
          MISSING_SECRETS="$MISSING_SECRETS RAILWAY_TOKEN"
        fi
        
        echo ""
        
        # Set outputs
        echo "all_good=$ALL_GOOD" >> $GITHUB_OUTPUT
        echo "missing=$MISSING_SECRETS" >> $GITHUB_OUTPUT
    
    - name: Check Optional Secrets
      run: |
        echo "üìã Checking optional secrets..."
        echo ""
        
        # Check RAILWAY_TOKEN_STAGING
        if [ -n "${{ secrets.RAILWAY_TOKEN_STAGING }}" ]; then
          echo "‚úÖ RAILWAY_TOKEN_STAGING is configured (staging deployments enabled)"
        else
          echo "‚ÑπÔ∏è RAILWAY_TOKEN_STAGING not configured (staging deployments will use production token)"
        fi
        
        # Check CLAUDE_API_KEY_TEST
        if [ -n "${{ secrets.CLAUDE_API_KEY_TEST }}" ]; then
          echo "‚úÖ CLAUDE_API_KEY_TEST is configured (separate test key available)"
        else
          echo "‚ÑπÔ∏è CLAUDE_API_KEY_TEST not configured (tests will use main key)"
        fi
        
        echo ""
    
    - name: Test Python Environment
      run: |
        echo "üêç Testing Python environment..."
        python --version
        pip --version
        echo "‚úÖ Python environment is functional"
        echo ""
    
    - name: Test API Key Functionality
      id: test_api
      env:
        CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
      run: |
        if [ -n "$CLAUDE_API_KEY" ]; then
          echo "üîå Testing Claude API connection..."
          
          # Create a test script
          cat > test_api.py << 'EOF'
import os
import sys

try:
    from anthropic import Anthropic
    
    # Initialize client
    client = Anthropic(api_key=os.environ.get('CLAUDE_API_KEY'))
    
    # Try a minimal API call
    try:
        # This is just to test the key validity
        # We're not actually making a call to save API usage
        if client.api_key and client.api_key.startswith('sk-ant-'):
            print("‚úÖ API key format is valid")
            print("   Note: Actual API call skipped to save usage")
        else:
            print("‚ö†Ô∏è API key format may be invalid")
    except Exception as e:
        print(f"‚ö†Ô∏è Could not validate API: {str(e)}")
        
except ImportError:
    print("‚ö†Ô∏è Anthropic package not installed (will be installed during deployment)")
EOF
          
          # Install anthropic temporarily
          pip install anthropic -q
          
          # Run test
          python test_api.py
        else
          echo "‚ö†Ô∏è Skipping API test (CLAUDE_API_KEY not set)"
        fi
    
    - name: Test Railway CLI
      run: |
        echo "üöÇ Testing Railway CLI installation..."
        
        # Test npm availability
        if command -v npm &> /dev/null; then
          echo "‚úÖ npm is available"
          
          # Test Railway CLI can be installed
          npm list -g @railway/cli &> /dev/null || echo "‚ÑπÔ∏è Railway CLI not installed (will be installed during deployment)"
        else
          echo "‚ö†Ô∏è npm not found (needed for Railway deployment)"
        fi
        
        echo ""
    
    - name: Validate Deployment Files
      run: |
        echo "üìÑ Checking deployment configuration files..."
        
        FILES_OK=true
        
        # Check required files
        for file in "requirements.txt" "Procfile" "railway.json" "app.py"; do
          if [ -f "$file" ]; then
            echo "‚úÖ $file exists"
          else
            echo "‚ùå $file is missing"
            FILES_OK=false
          fi
        done
        
        # Check Railway configuration
        if [ -f "railway.json" ]; then
          # Validate JSON syntax
          python -m json.tool railway.json > /dev/null 2>&1 && echo "   ‚úì railway.json is valid JSON" || echo "   ‚ö†Ô∏è railway.json has invalid JSON syntax"
        fi
        
        # Check Procfile
        if [ -f "Procfile" ]; then
          if grep -q "web:" Procfile; then
            echo "   ‚úì Procfile has web process defined"
          else
            echo "   ‚ö†Ô∏è Procfile missing web process"
          fi
        fi
        
        echo ""
        
        if [ "$FILES_OK" = "false" ]; then
          echo "‚ö†Ô∏è Some deployment files are missing"
        fi
    
    - name: Generate Report
      run: |
        echo "## üìä Secrets Validation Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### Required Secrets" >> $GITHUB_STEP_SUMMARY
        echo "| Secret | Status | Notes |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|--------|-------|" >> $GITHUB_STEP_SUMMARY
        
        # CLAUDE_API_KEY status
        if [ -n "${{ secrets.CLAUDE_API_KEY }}" ]; then
          echo "| CLAUDE_API_KEY | ‚úÖ Configured | Required for AI analysis |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| CLAUDE_API_KEY | ‚ùå Missing | **Action required** |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # RAILWAY_TOKEN status
        if [ -n "${{ secrets.RAILWAY_TOKEN }}" ]; then
          echo "| RAILWAY_TOKEN | ‚úÖ Configured | Ready for deployment |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| RAILWAY_TOKEN | ‚ö†Ô∏è Missing | Deployment will fail |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Optional Secrets" >> $GITHUB_STEP_SUMMARY
        echo "| Secret | Status | Purpose |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|--------|---------|" >> $GITHUB_STEP_SUMMARY
        
        # Optional secrets
        if [ -n "${{ secrets.RAILWAY_TOKEN_STAGING }}" ]; then
          echo "| RAILWAY_TOKEN_STAGING | ‚úÖ Set | Staging deployments |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| RAILWAY_TOKEN_STAGING | ‚ÑπÔ∏è Not set | Will use production token |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -n "${{ secrets.CLAUDE_API_KEY_TEST }}" ]; then
          echo "| CLAUDE_API_KEY_TEST | ‚úÖ Set | Testing environment |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| CLAUDE_API_KEY_TEST | ‚ÑπÔ∏è Not set | Will use main key |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Action items
        if [ "${{ steps.check_required.outputs.all_good }}" != "true" ]; then
          echo "### ‚ö†Ô∏è Action Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Missing required secrets: ${{ steps.check_required.outputs.missing }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please follow the instructions in SECRETS_SETUP.md to configure missing secrets." >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚úÖ All Required Secrets Configured" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your repository is ready for deployment!" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Run this workflow anytime to validate your secrets configuration.*" >> $GITHUB_STEP_SUMMARY
    
    - name: Final Status
      run: |
        if [ "${{ steps.check_required.outputs.all_good }}" = "true" ]; then
          echo "‚úÖ All required secrets are properly configured!"
          echo "Your repository is ready for deployment."
        else
          echo "‚ö†Ô∏è Some required secrets are missing."
          echo "Please configure the missing secrets before attempting deployment."
          echo ""
          echo "See SECRETS_SETUP.md for detailed instructions."
          exit 1
        fi
